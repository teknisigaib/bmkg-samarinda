name: Deploy via Self-Hosted Runner

on:
  push:
    branches: [ "main" ]

env:
  # Ganti 'dockerhub-username' dengan username asli Anda jika belum sesuai
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/bmkg-samarinda:latest
  CONTAINER_NAME: bmkg-samarinda
  # Path file .env di server VPS (untuk env server-side)
  ENV_PATH: /www/wwwroot/bmkg-samarinda/.env 

jobs:
  # TAHAP 1: BUILD (Dikerjakan di GitHub Cloud)
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Login ke Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & Push Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_NAME }}
          # --- PERBAIKAN UTAMA DISINI ---
          # Kita kirim Secrets GitHub ke dalam Docker Build
          build-args: |
            NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          # ------------------------------

  # TAHAP 2: DEPLOY (Dikerjakan di VPS Anda)
  deploy_local:
    needs: build_and_push
    runs-on: self-hosted 
    
    steps:
      - name: Login Docker di Local
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Tarik Image Terbaru
        run: docker pull ${{ env.IMAGE_NAME }}

      - name: Hapus Container Lama
        run: |
          docker stop ${{ env.CONTAINER_NAME }} || true
          docker rm ${{ env.CONTAINER_NAME }} || true

      - name: Jalankan Container Baru
        # Kita tetap mount .env server untuk variabel sisi server (non-PUBLIC)
        run: |
          docker run -d \
            -p 3000:3000 \
            --name ${{ env.CONTAINER_NAME }} \
            --restart always \
            --env-file ${{ env.ENV_PATH }} \
            ${{ env.IMAGE_NAME }}

      # Opsional: Jika Prisma butuh update schema
      # Pastikan DATABASE_URL ada di dalam file .env di server
      - name: Update Database (Prisma)
        run: docker exec ${{ env.CONTAINER_NAME }} npx prisma db push --skip-generate

      - name: Bersih-bersih Image Sampah
        run: docker image prune -f